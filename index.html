<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <title>Aero Defender</title>
    <style>
        /* Basic Resets */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        /* Game Container */
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #000;
            overflow: hidden;
        }

        /* Background Video */
        #bgVideo {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        /* Main Canvas */
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Screen Shake */
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0% { transform: translate(0,0); }
            20% { transform: translate(-10px,5px); }
            40% { transform: translate(10px,-5px); }
            60% { transform: translate(-10px,5px); }
            80% { transform: translate(10px,-5px); }
            100% { transform: translate(0,0); }
        }

        /* Top Panels */
        #topLeftPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 20;
        }
        #topLeftPanel div {
            font-size: 1rem;
            background: rgba(0,0,0,0.6);
            padding: 5px 8px;
            border-radius: 4px;
        }

        #topRightPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            z-index: 20;
        }
        #pauseButton {
            padding: 8px 12px;
            background: linear-gradient(45deg, #0066cc, #004080);
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s, transform 0.2s;
        }
        #pauseButton:hover {
            background: linear-gradient(45deg, #005bb5, #003d66);
            transform: scale(1.05);
        }

        .powerup-label {
            font-size: 0.9rem;
            text-align: right;
            margin-bottom: 3px;
        }
        .powerup-bar {
            position: relative;
            width: 120px;
            height: 20px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        .powerup-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
        }
        #shieldBar { background: #00aaff; width: 0%; }
        #magnetBar { background: #ff6600; width: 0%; }

        /* Menus & Modals */
        .menu-overlay, .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
        }
        .menu-overlay h1 {
            font-size: 3rem;
            margin-bottom: 2rem;
            color: #fff;
            text-shadow: 0 0 10px #00f;
        }
        .menu-overlay h2 {
            font-size: 2rem;
            margin-bottom: 1.5rem;
            color: #fff;
        }
        .menu-overlay button, .modal-content button {
            margin: 0.5rem;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            background: linear-gradient(45deg, #0066cc, #004080);
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            min-width: 200px;
            transition: background 0.3s, transform 0.2s;
        }
        .menu-overlay button:hover, .modal-content button:hover {
            background: linear-gradient(45deg, #005bb5, #003d66);
            transform: scale(1.03);
        }

        .modal-content {
            background: #333;
            padding: 1.5rem;
            border-radius: 10px;
            max-width: 70%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 400px;
        }

        /* Buy Missiles Modal */
        #buyMissilesModal .modal-content {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #missileCountContainer {
            margin: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }
        #missileCountContainer button {
            background: none;
            border: none;
            width: 20px;
            height: 20px;
            cursor: pointer;
            padding: 0;
        }
        #missileCountContainer img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #missileCountContainer button:hover img {
            transform: scale(1.05);
        }
        #missileCount { width: 40px; text-align: center; font-size: 1rem; }
        #totalCost { font-size: 1rem; margin: 1rem 0; }

        /* Store Items */
        #storeModal .modal-content {
            background: #333;
            border: 2px solid #ffcc00;
            max-width: 600px;
        }
        .store-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
            overflow-y: auto;
            max-height: 60vh;
        }
        .plane-item {
            padding: 1rem;
            background: #444;
            border-radius: 5px;
            text-align: center;
            position: relative;
        }
        .plane-item h3 {
            margin: 0.5rem 0;
            font-size: 1.1rem;
        }
        .plane-item p {
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }
        .stat-bar {
            display: flex;
            align-items: center;
            margin: 0.3rem 0;
            font-size: 0.8rem;
        }
        .stat-label {
            width: 70px;
            text-align: left;
        }
        .stat-fill {
            width: 100px;
            height: 10px;
            background: #666;
            border-radius: 5px;
            overflow: hidden;
        }
        .stat-fill div {
            height: 100%;
            background: #00aaff;
        }
        .plane-item:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        .plane-item.selected { border: 2px solid gold; }
        .plane-item.owned button {
            background: green;
            cursor: default;
        }

        /* Settings Modal */
        #settingsModal .modal-content {
            text-align: left;
        }
        .setting-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
        }
        .setting-option label {
            font-size: 1.1rem;
        }
        input[type="range"] {
            width: 150px;
            accent-color: #0066cc;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #0066cc;
        }

        /* Control Buttons */
        .control-buttons {
            position: absolute;
            left: 50%;
            bottom: 60px;
            transform: translateX(-50%);
            z-index: 50;
            display: grid;
            grid-template-areas:
                ". up ."
                "left . right"
                ". down .";
            grid-template-columns: 60px 60px 60px;
            grid-template-rows: 60px 60px 60px;
            gap: 10px;
        }
        .control-btn {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .control-btn:active { transform: scale(0.95); }
        #upButton { grid-area: up; }
        #leftButton { grid-area: left; }
        #rightButton { grid-area: right; }
        #downButton { grid-area: down; }

        /* Utility */
        .hidden { display: none !important; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .menu-overlay h1 { font-size: 2.5rem; }
            .menu-overlay h2 { font-size: 1.5rem; }
            .menu-overlay button, .modal-content button {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
                min-width: 160px;
            }
            #topLeftPanel div, .powerup-label { font-size: 0.9rem; }
            #pauseButton { font-size: 0.8rem; padding: 6px 10px; }
            .control-btn { width: 50px; height: 50px; font-size: 1.2rem; }
            .modal-content { padding: 1rem; max-width: 85%; }
            .store-items { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <video id="bgVideo" autoplay loop muted playsinline>
            <source src="videos/bgvideo.mp4" type="video/mp4" />
            Your browser does not support the video tag.
        </video>
        <canvas id="gameCanvas"></canvas>

        <!-- Top Left Panel -->
        <div id="topLeftPanel" class="hidden">
            <div>High Score: <span id="highScoreDisplay">0</span></div>
            <div>Score: <span id="scoreDisplay">0</span></div>
            <div>Coins: <span id="coinsDisplay">0</span></div>
            <div>Missiles: <span id="missilesDisplay">0</span></div>
        </div>

        <!-- Top Right Panel -->
        <div id="topRightPanel" class="hidden">
            <button id="pauseButton">Pause</button>
            <div id="shieldLabel" class="powerup-label hidden">Shield</div>
            <div id="shieldIndicator" class="powerup-bar hidden">
                <div id="shieldBar" class="powerup-fill"></div>
            </div>
            <div id="magnetLabel" class="powerup-label hidden">Magnet</div>
            <div id="magnetIndicator" class="powerup-bar hidden">
                <div id="magnetBar" class="powerup-fill"></div>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="menu-overlay">
            <h1>Aero Defender</h1>
            <button id="startButton">Start Game</button>
            <button id="buyMissileButton">Buy Missiles 🔥</button>
            <button id="storeButton">Store</button>
            <button id="settingsButton">Settings</button>
        </div>

        <!-- Pause Menu -->
        <div id="pauseMenu" class="menu-overlay hidden">
            <h2>Paused</h2>
            <button id="resumeButton">Resume</button>
            <button id="restartButton">Restart</button>
            <button id="mainMenuButton">Main Menu</button>
        </div>

        <!-- Game Over Menu -->
        <div id="gameOverMenu" class="menu-overlay hidden">
            <h2>Game Over</h2>
            <div>Score: <span id="finalScore">0</span></div>
            <div>Coins Collected: <span id="finalCoins">0</span></div>
            <div>Missiles Left: <span id="finalMissilesLeft">0</span></div>
            <button id="playAgainButton">Play Again</button>
            <button id="mainMenuButton2">Main Menu</button>
        </div>

        <!-- Buy Missiles Modal -->
        <div id="buyMissilesModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Buy Missiles 🔥</h2>
                <div style="margin-bottom: 1rem; font-size: 1rem;">
                    You have <span id="currentCoinsDisplay">0</span> coins and <span id="availableMissilesInModal">0</span> missiles.
                </div>
                <div id="missileCountContainer">
                    <button id="minusMissile"><img src="images/minus.png" alt="Minus"></button>
                    <span id="missileCount">1</span>
                    <button id="plusMissile"><img src="images/plus.png" alt="Plus"></button>
                </div>
                <div id="totalCost">10 Coins</div>
                <button id="closeBuyMissile">Close</button>
                <button id="confirmBuyMissile">Buy</button>
            </div>
        </div>

        <!-- Store Modal -->
        <div id="storeModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Aircraft Store</h2>
                <div>Your Coins: <span id="storeCoins">0</span></div>
                <div id="planesList" class="store-items"></div>
                <button id="closeStore">Close Store</button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>SETTINGS</h2>
                <div class="setting-option">
                    <label for="musicVolumeSlider">Music Volume</label>
                    <input type="range" id="musicVolumeSlider" min="0" max="100" value="50" />
                </div>
                <div class="setting-option">
                    <label for="sfxVolumeSlider">Sound Effects Volume</label>
                    <input type="range" id="sfxVolumeSlider" min="0" max="100" value="75" />
                </div>
                <div class="setting-option">
                    <label for="vibrationToggle">Vibration</label>
                    <input type="checkbox" id="vibrationToggle" />
                </div>
                <div class="setting-option">
                    <label for="fpsToggle">Show FPS</label>
                    <input type="checkbox" id="fpsToggle" />
                </div>
                <div class="setting-option">
                    <label for="arrowControlsToggle">Show Arrow Controls</label>
                    <input type="checkbox" id="arrowControlsToggle" checked />
                </div>
                <button id="saveSettings">SAVE SETTINGS</button>
                <button id="closeSettings">Close</button>
            </div>
        </div>

        <!-- Mobile Controls -->
        <div id="controls" class="control-buttons hidden">
            <button id="upButton" class="control-btn">⬆️</button>
            <button id="leftButton" class="control-btn">⬅️</button>
            <button id="rightButton" class="control-btn">➡️</button>
            <button id="downButton" class="control-btn">⬇️</button>
        </div>
    </div>

    <script>
        // Game Configuration
        const GAME_CONFIG = {
            missileSpawnRate: 1500,
            coinSpawnRate: 2000,
            newCoinSpawnRate: 5000,
            shieldSpawnRate: 15000,
            magnetSpawnRate: 30000,
            magnetDuration: 10000,
            coinValue: 10,
            newCoinValue: 20,
            shieldDuration: 10000,
            magnetAttractionRadius: 250,
            magnetAttractionSpeed: 12,
            missileCost: 10,
            planeImages: [
                { id: 0, src: 'images/plane1.png', price: 0, name: 'Standard Fighter', desc: 'Balanced performance', stats: { speed: 50, handling: 40, fireRate: 30 } },
                { id: 1, src: 'images/plane2.png', price: 100, name: 'Interceptor', desc: 'High speed', stats: { speed: 80, handling: 60, fireRate: 40 } },
                { id: 2, src: 'images/plane3.png', price: 200, name: 'Heavy Bomber', desc: 'Powerful and durable', stats: { speed: 20, handling: 40, fireRate: 60 } },
                { id: 3, src: 'images/plane4.png', price: 300, name: 'Stealth Jet', desc: 'Ultimate performance', stats: { speed: 90, handling: 70, fireRate: 50 } }
            ]
        };

        // Global Variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        let gameState = 'menu';
        let score = 0, coinsCollected = 0;
        let coins = parseInt(localStorage.getItem('coins')) || 0;
        let highScore = parseInt(localStorage.getItem('highScore')) || 0;
        let playerMissiles = parseInt(localStorage.getItem('playerMissiles')) || 0;
        let animationFrameId = null;
        let lastFrameTime = 0;
        let ownedPlanes = JSON.parse(localStorage.getItem('ownedPlanes')) || [0];
        let selectedPlane = parseInt(localStorage.getItem('selectedPlane')) || 0;

        // Settings
        let showArrowControls = localStorage.getItem('showArrowControls') === 'false' ? false : true;
        let vibrationEnabled = localStorage.getItem('vibration') === 'true' || false;

        // Game Objects
        const plane = {
            x: canvas.width / 2,
            y: canvas.height * 0.7,
            width: 60,
            height: 60,
            speed: 0, // Set in startGame
            getBounds() {
                return {
                    left: this.x - this.width / 2,
                    right: this.x + this.width / 2,
                    top: this.y - this.height / 2,
                    bottom: this.y + this.height / 2
                };
            }
        };

        let missiles = [], coinsArray = [], powerups = [], firedProjectiles = [];
        let particles = [], explosionParticles = [], accelerationParticles = [];
        let isShieldActive = false, isMagnetActive = false;
        let shieldEndTime = 0, magnetEndTime = 0;
        let isDraggingPlane = false, dragOffsetX = 0, dragOffsetY = 0;
        let lastMissileTime = 0, lastCoinTime = 0, lastNewCoinTime = 0, lastShieldTime = 0, lastMagnetTime = 0;
        let touchX, touchY;

        // Asset Loading
        const assets = {
            planes: [],
            missile: new Image(),
            coin: new Image(),
            newCoin: new Image(),
            shield: new Image(),
            magnet: new Image(),
            fire: new Image()
        };
        let assetsLoaded = 0;
        const totalAssets = GAME_CONFIG.planeImages.length + 5;

        function loadAsset(img, src) {
            return new Promise((resolve) => {
                img.onload = () => {
                    assetsLoaded++;
                    if (assetsLoaded === totalAssets) init();
                    resolve();
                };
                img.onerror = () => {
                    console.error(`Failed to load asset: ${src}`);
                    assetsLoaded++;
                    if (assetsLoaded === totalAssets) init();
                    resolve();
                };
                img.src = src;
            });
        }

        GAME_CONFIG.planeImages.forEach((plane, i) => {
            assets.planes[i] = new Image();
            loadAsset(assets.planes[i], plane.src);
        });
        loadAsset(assets.missile, 'images/missile.png');
        loadAsset(assets.coin, 'images/coin.png');
        loadAsset(assets.newCoin, 'images/newcoin.png');
        loadAsset(assets.shield, 'images/shield.png');
        loadAsset(assets.magnet, 'images/magnet.png');
        loadAsset(assets.fire, 'images/fire.png');

        // Sound Management
        const sounds = {
            click: new Audio('sounds/click.mp3'),
            coin: new Audio('sounds/coinsound.mp3'),
            shield: new Audio('sounds/shieldcollected.mp3'),
            booster: new Audio('sounds/booster.mp3'),
            explosion: new Audio('sounds/explosion.mp3'),
            collision: new Audio('sounds/collision.mp3'),
            out: new Audio('sounds/out.mp3'),
            buy: new Audio('sounds/buy.mp3'),
            destroy: new Audio('sounds/destroy.mp3'),
            background: new Audio('sounds/background.mp3')
        };

        function playSound(sound) {
            if (sounds[sound]) {
                sounds[sound].currentTime = 0;
                sounds[sound].volume = document.getElementById('sfxVolumeSlider').value / 100;
                sounds[sound].play().catch(() => {});
            }
            if (vibrationEnabled && navigator.vibrate && (sound === 'out' || sound === 'destroy')) {
                navigator.vibrate(sound === 'out' ? 200 : 100);
            }
        }

        function playBackgroundMusic() {
            sounds.background.loop = true;
            sounds.background.volume = document.getElementById('musicVolumeSlider').value / 100;
            sounds.background.play().catch(() => {});
        }

        function pauseBackgroundMusic() {
            sounds.background.pause();
        }

        function stopBackgroundMusic() {
            sounds.background.pause();
            sounds.background.currentTime = 0;
        }

        // Particle Effects
        function createParticles(x, y, type = 'coin') {
            const count = type === 'coin' ? 10 : 15;
            const color = type === 'coin' ? 'yellow' : 'orange';
            for (let i = 0; i < count; i++) {
                (type === 'coin' ? particles : explosionParticles).push({
                    x, y,
                    radius: Math.random() * 3 + 2,
                    vx: (Math.random() - 0.5) * (type === 'coin' ? 4 : 6),
                    vy: (Math.random() - 0.5) * (type === 'coin' ? 4 : 6),
                    alpha: 1.0,
                    color
                });
            }
        }

        function createAccelerationParticles() {
            if (keysPressed['ArrowUp']) {
                accelerationParticles.push({
                    x: plane.x,
                    y: plane.y + plane.height / 2,
                    radius: 3,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2 + 2,
                    alpha: 1.0,
                    color: 'red'
                });
            }
        }

        function updateParticles() {
            [particles, explosionParticles, accelerationParticles].forEach(arr => {
                for (let i = arr.length - 1; i >= 0; i--) {
                    const p = arr[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.alpha -= 0.02;
                    if (p.alpha <= 0) arr.splice(i, 1);
                }
            });
        }

        function drawParticles() {
            [particles, explosionParticles, accelerationParticles].forEach(arr => {
                arr.forEach(p => {
                    ctx.save();
                    ctx.globalAlpha = p.alpha;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
            });
        }

        // Game Logic
        function fireProjectile() {
            if (playerMissiles > 0) {
                playerMissiles--;
                updateUI();
                localStorage.setItem('playerMissiles', playerMissiles);
                firedProjectiles.push({
                    x: plane.x,
                    y: plane.y - plane.height / 2,
                    width: 10,
                    height: 20,
                    speed: 8,
                    getBounds() {
                        return {
                            left: this.x - this.width / 2,
                            right: this.x + this.width / 2,
                            top: this.y - this.height / 2,
                            bottom: this.y + this.height / 2
                        };
                    }
                });
            }
        }

        function spawnMissile() {
            missiles.push({
                x: Math.random() * canvas.width,
                y: -60,
                width: 30,
                height: 60,
                speed: 4 * (1 + score / 2000),
                getBounds() {
                    return {
                        left: this.x - this.width / 2,
                        right: this.x + this.width / 2,
                        top: this.y - this.height / 2,
                        bottom: this.y + this.height / 2
                    };
                }
            });
        }

        function spawnCoin(isNewCoin = false) {
            const size = 30;
            coinsArray.push({
                x: Math.random() * canvas.width,
                y: -size,
                width: size,
                height: size,
                speed: 3,
                value: isNewCoin ? GAME_CONFIG.newCoinValue : GAME_CONFIG.coinValue,
                isNewCoin,
                getBounds() {
                    return {
                        left: this.x - this.width / 2,
                        right: this.x + this.width / 2,
                        top: this.y - this.height / 2,
                        bottom: this.y + this.height / 2
                    };
                }
            });
        }

        function spawnPowerup(type) {
            const size = type === 'magnet' ? 50 : 40;
            powerups.push({
                x: Math.random() * canvas.width,
                y: -size,
                width: size,
                height: size,
                speed: 3,
                type,
                getBounds() {
                    return {
                        left: this.x - this.width / 2,
                        right: this.x + this.width / 2,
                        top: this.y - this.height / 2,
                        bottom: this.y + this.height / 2
                    };
                }
            });
        }

        function checkCollision(obj1, obj2) {
            const b1 = obj1.getBounds(), b2 = obj2.getBounds();
            return !(b1.right < b2.left || b1.left > b2.right || b1.bottom < b2.top || b1.top > b2.bottom);
        }

        // Game Loop
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastFrameTime;
            if (deltaTime >= 1000 / 60) {
                lastFrameTime = timestamp - (deltaTime % (1000 / 60));
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (gameState === 'playing') {
                    updateGame();
                    drawGame();
                }
            }
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function updateGame() {
            score += 0.1;
            updateUI();

            const now = Date.now();
            if (now - lastMissileTime > GAME_CONFIG.missileSpawnRate / (1 + score / 2000)) {
                spawnMissile();
                lastMissileTime = now;
            }
            if (now - lastCoinTime > GAME_CONFIG.coinSpawnRate) {
                spawnCoin(false);
                lastCoinTime = now;
            }
            if (now - lastNewCoinTime > GAME_CONFIG.newCoinSpawnRate) {
                spawnCoin(true);
                lastNewCoinTime = now;
            }
            if (now - lastShieldTime > GAME_CONFIG.shieldSpawnRate) {
                spawnPowerup('shield');
                lastShieldTime = now;
            }
            if (now - lastMagnetTime > GAME_CONFIG.magnetSpawnRate) {
                spawnPowerup('magnet');
                lastMagnetTime = now;
            }

            if (isDraggingPlane) {
                plane.x = Math.max(plane.width / 2, Math.min(canvas.width - plane.width / 2, touchX - dragOffsetX));
                plane.y = Math.max(plane.height / 2, Math.min(canvas.height - plane.height / 2, touchY - dragOffsetY));
            }

            if (keysPressed['ArrowUp']) {
                plane.y -= plane.speed;
                createAccelerationParticles();
            }
            if (keysPressed['ArrowDown']) plane.y += plane.speed;
            if (keysPressed['ArrowLeft']) plane.x -= plane.speed;
            if (keysPressed['ArrowRight']) plane.x += plane.speed;
            plane.x = Math.max(plane.width / 2, Math.min(canvas.width - plane.width / 2, plane.x));
            plane.y = Math.max(plane.height / 2, Math.min(canvas.height - plane.height / 2, plane.y));

            updateMissiles();
            updateCoins();
            updatePowerups();
            updateFiredProjectiles();
            updateParticles();

            if (isShieldActive && now > shieldEndTime) {
                isShieldActive = false;
                document.getElementById('shieldIndicator').classList.add('hidden');
                document.getElementById('shieldLabel').classList.add('hidden');
            }
            if (isMagnetActive && now > magnetEndTime) {
                isMagnetActive = false;
                document.getElementById('magnetIndicator').classList.add('hidden');
                document.getElementById('magnetLabel').classList.add('hidden');
            }
            if (isShieldActive) document.getElementById('shieldBar').style.width = `${((shieldEndTime - now) / GAME_CONFIG.shieldDuration) * 100}%`;
            if (isMagnetActive) document.getElementById('magnetBar').style.width = `${((magnetEndTime - now) / GAME_CONFIG.magnetDuration) * 100}%`;
        }

        function drawGame() {
            plane.draw = () => {
                ctx.save();
                ctx.translate(plane.x, plane.y);
                ctx.drawImage(assets.planes[selectedPlane], -plane.width/2, -plane.height/2, plane.width, plane.height);
                if (isShieldActive) {
                    ctx.beginPath();
                    ctx.arc(0, 0, plane.width/1.5, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(0,200,255,0.8)';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    ctx.fillStyle = 'rgba(0,200,255,0.2)';
                    ctx.fill();
                }
                ctx.restore();
            };
            plane.draw();

            missiles.forEach(m => {
                m.draw = () => ctx.drawImage(assets.missile, m.x - m.width/2, m.y - m.height/2, m.width, m.height);
                m.draw();
            });
            coinsArray.forEach(c => {
                c.draw = () => ctx.drawImage(c.isNewCoin ? assets.newCoin : assets.coin, c.x - c.width/2, c.y - c.height/2, c.width, c.height);
                c.draw();
            });
            powerups.forEach(p => {
                p.draw = () => ctx.drawImage(p.type === 'shield' ? assets.shield : assets.magnet, p.x - p.width/2, p.y - p.height/2, p.width, p.height);
                p.draw();
            });
            firedProjectiles.forEach(p => {
                p.draw = () => ctx.drawImage(assets.fire, p.x - p.width/2, p.y - p.height/2, p.width, p.height);
                p.draw();
            });
            drawParticles();
        }

        function updateMissiles() {
            for (let i = missiles.length - 1; i >= 0; i--) {
                missiles[i].y += missiles[i].speed;
                if (missiles[i].y > canvas.height + missiles[i].height) {
                    missiles.splice(i, 1);
                    continue;
                }
                if (checkCollision(plane, missiles[i])) {
                    if (isShieldActive) {
                        missiles.splice(i, 1);
                        playSound('explosion');
                    } else {
                        gameOver();
                        document.getElementById('gameContainer').classList.add('shake');
                        setTimeout(() => document.getElementById('gameContainer').classList.remove('shake'), 500);
                    }
                }
            }
        }

        function updateCoins() {
            for (let i = coinsArray.length - 1; i >= 0; i--) {
                let coin = coinsArray[i];
                if (isMagnetActive) {
                    let dx = plane.x - coin.x, dy = plane.y - coin.y;
                    let distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < GAME_CONFIG.magnetAttractionRadius) {
                        let angle = Math.atan2(dy, dx);
                        coin.x += Math.cos(angle) * GAME_CONFIG.magnetAttractionSpeed;
                        coin.y += Math.sin(angle) * GAME_CONFIG.magnetAttractionSpeed;
                    } else {
                        coin.y += coin.speed;
                    }
                } else {
                    coin.y += coin.speed;
                }
                if (coin.y > canvas.height + coin.height) {
                    coinsArray.splice(i, 1);
                    continue;
                }
                if (checkCollision(plane, coin)) {
                    coins += coin.value;
                    coinsCollected += coin.value;
                    coinsArray.splice(i, 1);
                    playSound('coin');
                    createParticles(coin.x, coin.y, 'coin');
                    updateUI();
                }
            }
        }

        function updatePowerups() {
            for (let i = powerups.length - 1; i >= 0; i--) {
                powerups[i].y += powerups[i].speed;
                if (powerups[i].y > canvas.height + powerups[i].height) {
                    powerups.splice(i, 1);
                    continue;
                }
                if (checkCollision(plane, powerups[i])) {
                    if (powerups[i].type === 'shield') {
                        isShieldActive = true;
                        shieldEndTime = Date.now() + GAME_CONFIG.shieldDuration;
                        playSound('shield');
                        document.getElementById('shieldIndicator').classList.remove('hidden');
                        document.getElementById('shieldLabel').classList.remove('hidden');
                    } else if (powerups[i].type === 'magnet') {
                        isMagnetActive = true;
                        magnetEndTime = Date.now() + GAME_CONFIG.magnetDuration;
                        playSound('booster');
                        document.getElementById('magnetIndicator').classList.remove('hidden');
                        document.getElementById('magnetLabel').classList.remove('hidden');
                    }
                    powerups.splice(i, 1);
                }
            }
        }

        function updateFiredProjectiles() {
            for (let i = firedProjectiles.length - 1; i >= 0; i--) {
                let p = firedProjectiles[i];
                p.y -= p.speed;
                if (p.y < -p.height) {
                    firedProjectiles.splice(i, 1);
                    continue;
                }
                for (let j = missiles.length - 1; j >= 0; j--) {
                    if (checkCollision(p, missiles[j])) {
                        createParticles(missiles[j].x, missiles[j].y, 'explosion');
                        playSound('destroy');
                        firedProjectiles.splice(i, 1);
                        missiles.splice(j, 1);
                        break;
                    }
                }
            }
        }

        // UI Updates
        function updateUI() {
            document.getElementById('highScoreDisplay').textContent = highScore;
            document.getElementById('scoreDisplay').textContent = Math.floor(score);
            document.getElementById('coinsDisplay').textContent = coins;
            document.getElementById('missilesDisplay').textContent = playerMissiles;
            document.getElementById('storeCoins').textContent = coins;
            document.getElementById('currentCoinsDisplay').textContent = coins;
            document.getElementById('availableMissilesInModal').textContent = playerMissiles;
        }

        let missileBuyCount = 1;
        function updateMissileBuyUI() {
            missileBuyCount = Math.max(1, missileBuyCount);
            document.getElementById('missileCount').textContent = missileBuyCount;
            document.getElementById('totalCost').textContent = `${missileBuyCount * GAME_CONFIG.missileCost} Coins`;
        }

        function buyMissiles() {
            const totalCost = missileBuyCount * GAME_CONFIG.missileCost;
            if (coins >= totalCost) {
                coins -= totalCost;
                playerMissiles += missileBuyCount;
                localStorage.setItem('coins', coins);
                localStorage.setItem('playerMissiles', playerMissiles);
                playSound('buy');
                updateUI();
                document.getElementById('buyMissilesModal').classList.add('hidden');
            } else {
                alert('Not enough coins!');
            }
        }

        // Game State Management
        function startGame() {
            gameState = 'playing';
            score = 0;
            coinsCollected = 0;
            missiles = [];
            coinsArray = [];
            powerups = [];
            firedProjectiles = [];
            particles = [];
            explosionParticles = [];
            accelerationParticles = [];
            isShieldActive = false;
            isMagnetActive = false;
            shieldEndTime = 0;
            magnetEndTime = 0;
            lastMissileTime = Date.now();
            lastCoinTime = Date.now();
            lastNewCoinTime = Date.now();
            lastShieldTime = Date.now();
            lastMagnetTime = Date.now();
            document.getElementById('shieldIndicator').classList.add('hidden');
            document.getElementById('shieldLabel').classList.add('hidden');
            document.getElementById('magnetIndicator').classList.add('hidden');
            document.getElementById('magnetLabel').classList.add('hidden');
            plane.x = canvas.width / 2;
            plane.y = canvas.height * 0.7;
            plane.speed = GAME_CONFIG.planeImages[selectedPlane].stats.speed / 10;
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('pauseMenu').classList.add('hidden');
            document.getElementById('gameOverMenu').classList.add('hidden');
            document.getElementById('topLeftPanel').classList.remove('hidden');
            document.getElementById('topRightPanel').classList.remove('hidden');
            if (showArrowControls) {
                document.getElementById('controls').classList.remove('hidden');
            }
            stopBackgroundMusic();
            playBackgroundMusic();
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            gameState = 'gameover';
            stopBackgroundMusic();
            playSound('out');
            if (Math.floor(score) > highScore) {
                highScore = Math.floor(score);
                localStorage.setItem('highScore', highScore);
            }
            coins += coinsCollected;
            localStorage.setItem('coins', coins);
            document.getElementById('topLeftPanel').classList.add('hidden');
            document.getElementById('topRightPanel').classList.add('hidden');
            document.getElementById('controls').classList.add('hidden');
            document.getElementById('finalScore').textContent = Math.floor(score);
            document.getElementById('finalCoins').textContent = coinsCollected;
            document.getElementById('finalMissilesLeft').textContent = playerMissiles;
            document.getElementById('gameOverMenu').classList.remove('hidden');
        }

        function pauseGame() {
            if (gameState === 'playing') {
                gameState = 'paused';
                pauseBackgroundMusic();
                document.getElementById('pauseMenu').classList.remove('hidden');
                document.getElementById('controls').classList.add('hidden');
            }
        }

        function resumeGame() {
            if (gameState === 'paused') {
                gameState = 'playing';
                document.getElementById('pauseMenu').classList.add('hidden');
                if (showArrowControls) {
                    document.getElementById('controls').classList.remove('hidden');
                }
                playBackgroundMusic();
            }
        }

        // Store Management
        function populateStore() {
            const planesList = document.getElementById('planesList');
            planesList.innerHTML = '';
            GAME_CONFIG.planeImages.forEach(planeInfo => {
                const div = document.createElement('div');
                div.className = `plane-item ${ownedPlanes.includes(planeInfo.id) ? 'owned' : ''} ${selectedPlane === planeInfo.id ? 'selected' : ''}`;
                div.innerHTML = `
                    <img src="${planeInfo.src}" alt="${planeInfo.name}" style="max-width: 100%; height: 100px; object-fit: contain;">
                    <h3>${planeInfo.name}</h3>
                    <p>${planeInfo.desc}</p>
                    <div class="stat-bar"><span class="stat-label">Speed</span><div class="stat-fill"><div style="width: ${planeInfo.stats.speed}%"></div></div></div>
                    <div class="stat-bar"><span class="stat-label">Handling</span><div class="stat-fill"><div style="width: ${planeInfo.stats.handling}%"></div></div></div>
                    <div class="stat-bar"><span class="stat-label">Fire Rate</span><div class="stat-fill"><div style="width: ${planeInfo.stats.fireRate}%"></div></div></div>
                    ${ownedPlanes.includes(planeInfo.id) ? 
                        `<button ${selectedPlane === planeInfo.id ? 'disabled' : ''}>${selectedPlane === planeInfo.id ? 'Selected' : 'Select'}</button>` :
                        `<div>${planeInfo.price} Coins</div><button ${coins >= planeInfo.price ? '' : 'disabled'}>Buy</button>`
                    }
                `;
                if (ownedPlanes.includes(planeInfo.id)) {
                    div.querySelector('button').addEventListener('click', () => {
                        selectedPlane = planeInfo.id;
                        plane.speed = GAME_CONFIG.planeImages[selectedPlane].stats.speed / 10;
                        localStorage.setItem('selectedPlane', selectedPlane);
                        playSound('click');
                        populateStore();
                    });
                } else if (coins >= planeInfo.price) {
                    div.querySelector('button').addEventListener('click', () => {
                        coins -= planeInfo.price;
                        ownedPlanes.push(planeInfo.id);
                        selectedPlane = planeInfo.id;
                        plane.speed = GAME_CONFIG.planeImages[selectedPlane].stats.speed / 10;
                        localStorage.setItem('coins', coins);
                        localStorage.setItem('ownedPlanes', JSON.stringify(ownedPlanes));
                        localStorage.setItem('selectedPlane', selectedPlane);
                        playSound('buy');
                        updateUI();
                        populateStore();
                    });
                }
                planesList.appendChild(div);
            });
        }

        // Input Handling
        let keysPressed = {};
        function setupControls() {
            window.addEventListener('keydown', e => {
                keysPressed[e.key] = true;
                if (e.key === 'Escape' && gameState === 'playing') pauseGame();
                if (e.key === ' ' && gameState === 'playing') fireProjectile();
            });
            window.addEventListener('keyup', e => keysPressed[e.key] = false);

            canvas.addEventListener('mousedown', e => {
                if (gameState === 'playing') {
                    const rect = canvas.getBoundingClientRect();
                    touchX = e.clientX - rect.left;
                    touchY = e.clientY - rect.top;
                    if (checkCollision({getBounds: () => ({left: touchX, right: touchX, top: touchY, bottom: touchY})}, plane)) {
                        fireProjectile();
                        isDraggingPlane = true;
                        dragOffsetX = touchX - plane.x;
                        dragOffsetY = touchY - plane.y;
                    }
                }
            });
            canvas.addEventListener('mousemove', e => {
                if (isDraggingPlane) {
                    const rect = canvas.getBoundingClientRect();
                    touchX = e.clientX - rect.left;
                    touchY = e.clientY - rect.top;
                }
            });
            window.addEventListener('mouseup', () => isDraggingPlane = false);

            canvas.addEventListener('touchstart', e => {
                if (gameState === 'playing' && e.touches.length === 1) {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    touchX = e.touches[0].clientX - rect.left;
                    touchY = e.touches[0].clientY - rect.top;
                    if (checkCollision({getBounds: () => ({left: touchX, right: touchX, top: touchY, bottom: touchY})}, plane)) {
                        fireProjectile();
                        isDraggingPlane = true;
                        dragOffsetX = touchX - plane.x;
                        dragOffsetY = touchY - plane.y;
                    }
                }
            }, { passive: false });
            canvas.addEventListener('touchmove', e => {
                if (isDraggingPlane && e.touches.length === 1) {
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    touchX = e.touches[0].clientX - rect.left;
                    touchY = e.touches[0].clientY - rect.top;
                }
            }, { passive: false });
            canvas.addEventListener('touchend', () => isDraggingPlane = false);

            ['up', 'left', 'right', 'down'].forEach(dir => {
                const btn = document.getElementById(`${dir}Button`);
                btn.addEventListener('touchstart', e => {
                    e.preventDefault();
                    keysPressed[`Arrow${dir.charAt(0).toUpperCase() + dir.slice(1)}`] = true;
                }, { passive: false });
                btn.addEventListener('touchend', () => keysPressed[`Arrow${dir.charAt(0).toUpperCase() + dir.slice(1)}`] = false);
            });
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('startButton').addEventListener('click', () => {
                playSound('click');
                startGame();
            });
            document.getElementById('buyMissileButton').addEventListener('click', () => {
                playSound('click');
                missileBuyCount = 1;
                updateMissileBuyUI();
                document.getElementById('buyMissilesModal').classList.remove('hidden');
            });
            document.getElementById('minusMissile').addEventListener('click', () => {
                if (missileBuyCount > 1) missileBuyCount--;
                updateMissileBuyUI();
            });
            document.getElementById('plusMissile').addEventListener('click', () => {
                missileBuyCount++;
                updateMissileBuyUI();
            });
            document.getElementById('confirmBuyMissile').addEventListener('click', () => {
                playSound('click');
                buyMissiles();
            });
            document.getElementById('closeBuyMissile').addEventListener('click', () => {
                playSound('click');
                document.getElementById('buyMissilesModal').classList.add('hidden');
            });
            document.getElementById('storeButton').addEventListener('click', () => {
                playSound('click');
                populateStore();
                document.getElementById('storeModal').classList.remove('hidden');
            });
            document.getElementById('closeStore').addEventListener('click', () => {
                playSound('click');
                document.getElementById('storeModal').classList.add('hidden');
            });
            document.getElementById('settingsButton').addEventListener('click', () => {
                playSound('click');
                document.getElementById('settingsModal').classList.remove('hidden');
            });
            document.getElementById('closeSettings').addEventListener('click', () => {
                playSound('click');
                document.getElementById('settingsModal').classList.add('hidden');
            });
            document.getElementById('saveSettings').addEventListener('click', () => {
                playSound('click');
                localStorage.setItem('musicVolume', document.getElementById('musicVolumeSlider').value);
                localStorage.setItem('sfxVolume', document.getElementById('sfxVolumeSlider').value);
                localStorage.setItem('vibration', document.getElementById('vibrationToggle').checked);
                localStorage.setItem('showArrowControls', document.getElementById('arrowControlsToggle').checked);
                showArrowControls = document.getElementById('arrowControlsToggle').checked;
                if (gameState === 'playing' && showArrowControls) {
                    document.getElementById('controls').classList.remove('hidden');
                } else if (gameState === 'playing') {
                    document.getElementById('controls').classList.add('hidden');
                }
                document.getElementById('settingsModal').classList.add('hidden');
                sounds.background.volume = document.getElementById('musicVolumeSlider').value / 100;
            });
            document.getElementById('pauseButton').addEventListener('click', () => {
                playSound('click');
                pauseGame();
            });
            document.getElementById('resumeButton').addEventListener('click', () => {
                playSound('click');
                resumeGame();
            });
            document.getElementById('restartButton').addEventListener('click', () => {
                playSound('click');
                startGame();
            });
            document.getElementById('mainMenuButton').addEventListener('click', () => {
                playSound('click');
                gameState = 'menu';
                stopBackgroundMusic();
                document.getElementById('pauseMenu').classList.add('hidden');
                document.getElementById('mainMenu').classList.remove('hidden');
            });
            document.getElementById('playAgainButton').addEventListener('click', () => {
                playSound('click');
                startGame();
            });
            document.getElementById('mainMenuButton2').addEventListener('click', () => {
                playSound('click');
                gameState = 'menu';
                stopBackgroundMusic();
                document.getElementById('gameOverMenu').classList.add('hidden');
                document.getElementById('mainMenu').classList.remove('hidden');
            });
        }

        // Initialization
        function init() {
            updateUI();
            setupControls();
            setupEventListeners();
            lastFrameTime = performance.now();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        if (assetsLoaded === totalAssets) init();
    </script>
</body>
</html>
